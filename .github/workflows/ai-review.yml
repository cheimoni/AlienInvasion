name: AI Game Review

on:
  push:
    branches: [main]
    paths:
      - '**.js'
      - '**.html'
      - '**.css'

jobs:
  ai-review:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - uses: actions/checkout@v4

      - name: Write review script
        run: |
          cat > /tmp/review.py << 'EOF'
          import json, urllib.request, os, subprocess
          from datetime import date

          token = os.environ['GH_TOKEN']
          sha = os.environ['GITHUB_SHA'][:7]
          repo = os.environ['GITHUB_REPOSITORY']
          today = date.today().isoformat()

          # Read game files
          code = ''
          for fname in ['engine.js', 'game.js', 'index.html', 'base.css']:
              try:
                  with open(fname, encoding='utf-8', errors='ignore') as f:
                      code += f'\n\n=== {fname} ===\n' + f.read(2500)
              except Exception:
                  pass

          # Call GitHub Models API
          payload = json.dumps({
              'model': 'gpt-4o-mini',
              'messages': [
                  {'role': 'system', 'content': 'You are an HTML5 game expert. Give 3-5 concise improvement suggestions for this AlienInvasion canvas game. Focus on gameplay and visuals.'},
                  {'role': 'user', 'content': 'Review this game and suggest improvements:\n' + code[:5000]}
              ],
              'max_tokens': 600
          }).encode()

          req = urllib.request.Request(
              'https://models.inference.ai.azure.com/chat/completions',
              data=payload,
              headers={'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json'}
          )

          try:
              with urllib.request.urlopen(req, timeout=60) as r:
                  data = json.loads(r.read())
                  suggestions = data['choices'][0]['message']['content']
          except urllib.error.HTTPError as e:
              suggestions = 'API Error ' + str(e.code) + ': ' + e.read().decode()[:400]
          except Exception as e:
              suggestions = 'Error: ' + str(e)

          # Create issue via GitHub API
          body = '## AI Game Review\n\nPush: `' + sha + '`\n\n---\n\n' + suggestions + '\n\n---\n*GitHub Models (gpt-4o-mini)*'
          issue_payload = json.dumps({'title': 'AI Review [' + sha + '] - ' + today, 'body': body, 'labels': ['ai-review']}).encode()

          req2 = urllib.request.Request(
              'https://api.github.com/repos/' + repo + '/issues',
              data=issue_payload,
              headers={'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json', 'Accept': 'application/vnd.github+json'}
          )
          with urllib.request.urlopen(req2) as r:
              result = json.loads(r.read())
              print('Issue:', result['html_url'])
          EOF

      - name: Run review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python3 /tmp/review.py
