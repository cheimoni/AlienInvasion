name: AI Game Review (GitHub Models)

on:
  push:
    branches: [main]
    paths:
      - '**.js'
      - '**.html'
      - '**.css'

jobs:
  ai-review:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ask AI and create issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Read game code (first 6000 chars total)
          CODE=$(head -c 2000 engine.js 2>/dev/null)
          CODE="$CODE $(head -c 2000 game.js 2>/dev/null)"
          CODE="$CODE $(head -c 2000 index.html 2>/dev/null)"

          SHA="${{ github.sha }}"
          SHORT_SHA="${SHA:0:7}"
          TODAY=$(date +%Y-%m-%d)

          # Save code to file to avoid escaping issues
          echo "$CODE" > /tmp/game_code.txt

          # Build JSON payload using Python
          SUGGESTIONS=$(python3 -c "
          import json, urllib.request, os, sys

          with open('/tmp/game_code.txt') as f:
              code = f.read()

          payload = json.dumps({
              'model': 'gpt-4o-mini',
              'messages': [
                  {'role': 'system', 'content': 'You are an HTML5 game developer. Give 3-5 specific improvement suggestions for this AlienInvasion canvas game. Be concise.'},
                  {'role': 'user', 'content': 'Suggest improvements for this game code:\n' + code[:5000]}
              ],
              'max_tokens': 800
          }).encode()

          req = urllib.request.Request(
              'https://models.inference.ai.azure.com/chat/completions',
              data=payload,
              headers={
                  'Authorization': 'Bearer ' + os.environ['GH_TOKEN'],
                  'Content-Type': 'application/json'
              }
          )
          try:
              with urllib.request.urlopen(req, timeout=60) as r:
                  data = json.loads(r.read())
                  print(data['choices'][0]['message']['content'])
          except urllib.error.HTTPError as e:
              print('API Error', e.code, e.reason, e.read().decode()[:300])
          except Exception as e:
              print('Error:', e)
          ")

          # Create GitHub Issue using gh CLI
          gh issue create \
            --title "AI Review [$SHORT_SHA] - $TODAY" \
            --body "## AI Game Review

Triggered by push \`$SHORT_SHA\`.

---

$SUGGESTIONS

---
*Via GitHub Models (gpt-4o-mini)*" \
            --label "ai-review"
